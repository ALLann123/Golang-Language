package main

import (
	"log"
	"net/http"
	"net/http/httputil"
	"net/url"
	"os"
	"os/signal"
	"syscall"
)

func main() {
	// Covenant C2 server IP- Change this to your actual C2 server
	covenantServer := "http://192.168.1.108:80"

	targetURL, err := url.Parse(covenantServer)

	if err != nil {
		log.Fatalf("Invalid C2 server URL: %v", err)
	}

	//Create reverse proxy
	proxy := httputil.NewSingleHostReverseProxy((targetURL))

	//Custom director to handle path rewriting and add red team headers
	originalDirector := proxy.Director
	proxy.Director = func(req *http.Request) {
		originalDirector(req)

		//Add red team headers(Mimic legitimate traffic)
		req.Header.Set("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36")
		req.Header.Set("Accept", "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8")
		req.Header.Set("Accept-Language", "en-US,en;q=0.5")
		req.Header.Set("Accept-Encoding", "gzip, deflate")

		//Log the request for red team monitoring
		log.Printf("[COVENANT] %s %s %s", req.RemoteAddr, req.Method, req.URL.Path)
	}

	//Create HTTP handle for specific routes only
	mux := http.NewServeMux()

	//Define the routes that covenant uses(mimicking your apache config)
	routes := []string{
		"/en-us/index.html",
		"/en-us/docs.html",
		"/en-us/test.html",
	}

	//Handle only the specific covenant routes
	for _, route := range routes {
		mux.HandleFunc(route, func(w http.ResponseWriter, r *http.Request) {
			log.Printf("[PROXY] Forwarding %s to covenant C2", r.URL.Path)
			proxy.ServeHTTP(w, r)
		})
	}

	//Handle all other routes with 404(stealth mode)
	mux.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
		log.Printf("[BLOCKED] Non-C2 request: %s from %s", r.URL.Path, r.RemoteAddr)
		http.NotFound(w, r)
	})

	//Create HTTP server
	server := &http.Server{
		Addr:    ":80", //listen on port 80
		Handler: mux,
	}

	//Graceful shutdown
	go func() {
		sigChan := make(chan os.Signal, 1)
		signal.Notify(sigChan, os.Interrupt, syscall.SIGTERM)
		<-sigChan

		log.Println("[SHUTDOWN] Gracefully shutting down proxy...")
		server.Close()
	}()
	log.Println("[START] Covenant C2 Reverse Proxy starting on :80")
	log.Println("[INFO] Forwarding C2 traffic to:", covenantServer)
	log.Printf("[INFO] Monitoring routes: %v", routes)

	if err := server.ListenAndServe(); err != nil {
		log.Fatalf("[ERROR] Server failed: %v", err)
	}
}
