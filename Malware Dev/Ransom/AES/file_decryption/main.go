package main

import (
	"crypto/aes"
	"crypto/cipher"
	"encoding/hex"
	"fmt"
	"os"
)

func main() {
	//file to decrypt
	inputFile := "hello.txt.encrypted"

	//Step 1: Ask for the encryption key
	fmt.Print("Enter the AES key(hex): ")
	var keyHex string
	_, err := fmt.Scanln(&keyHex)
	if err != nil {
		fmt.Printf("Failed to read key: %v\n", err)
		return
	}

	var outputFile string
	fmt.Println("Enter output filename: ")
	fmt.Scanln(&outputFile)

	decryptedFile := decryptFile(inputFile, keyHex, outputFile)
	// Step 10: Success message
	fmt.Println("\n✅ Decryption successful!")
	fmt.Printf("Decrypted file saved as: %s\n", decryptedFile)

}

func decryptFile(inputFile, keyHex, outputFile string) string {
	//Step 2: Decode the hex key
	key, err := hex.DecodeString(keyHex)
	if err != nil {
		fmt.Printf("Invalid hex key: %v\n", err)
		fmt.Println("Make suere you enter the exact key from encryption")
	}

	//step 3: Verify key length
	if len(key) != 32 {
		fmt.Printf("Invalid key length: got %d bytes, expected 32 bytes\n", len(key))
	}

	//step 4: Read the encrypted file
	ciphertext, err := os.ReadFile(inputFile)
	if err != nil {
		fmt.Printf("Failed to reaad encrypted file: %v\n", err)
		fmt.Println("Make sure 'hell.text.encrypted' exists in current directory")
	}

	//Step 5: create the AES cipher block
	block, err := aes.NewCipher(key)
	if err != nil {
		fmt.Printf("Failed to creae cipher: %v\n", err)
	}

	//Step 6:
	gcm, err := cipher.NewGCM(block)
	if err != nil {
		fmt.Printf("Failed to create GCM: %v\n", err)
	}

	//step 7: Extract nonce from ciphertext
	nonceSize := gcm.NonceSize()
	if len(ciphertext) < nonceSize {
		fmt.Printf("Ciphertext too short: got %d bytes, need at least %d bytes \n", len(ciphertext), nonceSize)

	}

	//First nonceSize bytes are the nonce, rest is ciphertext+tag
	nonce, encryptedData := ciphertext[:nonceSize], ciphertext[nonceSize:]

	//step 8: Decrypt and authenticate
	plaintext, err := gcm.Open(nil, nonce, encryptedData, nil)

	if err != nil {
		fmt.Printf("Decryption failed: %v\n", err)
		fmt.Println("Possible causes:")
		fmt.Println("1. Wrong key entered")
		fmt.Println("2. File corrupted or modified")
		fmt.Println("3. Incorrect encryption algorithm")
	}

	//Step 9: Write the decrypted data to a new file
	if err := os.WriteFile(outputFile, plaintext, 0644); err != nil {
		fmt.Printf("Failed to write decrypted file: %v\n", err)
	}

	return outputFile
}
/*
cmd >> more hello.txt.encrypted

▒v≈
ú└π∟Q╝╟▄≥╞╢ö┼♦öU┘wÑ╤+,ⁿφ¡sx    óq╓↓♫0I½ïnß2╖3▐░∙

J:\Go\Malware Development\ransomware\AES\file_decryption>go run main.go
Enter the AES key(hex): f38e08b5a94241d4a48c657fcfb640264d9c4c6822b4c04ad213e98f9234ab2d
Enter output filename:
hello.txt

✅ Decryption successful!
Decrypted file saved as: hello.txt

J:\Go\Malware Development\ransomware\AES\file_decryption>more hello.txt
"hacker own_the_net"

*/