package main

import (
	"crypto/aes"
	"crypto/cipher"
	"crypto/rand"
	"fmt"
	"io"
	"os"
)

func main() {
	//file to encrypt
	inputFile := "hello.txt"

	outputFile := encryptFile(inputFile)

	fmt.Printf("File encrypted successfully!\n")
	fmt.Printf("Original: %s\n", inputFile)
	fmt.Printf("Encrypted: %s\n", outputFile)
	fmt.Printf("\nIMPORTANT: Keep the key safe! Without it, the file cannot be decrypted.\n")

}

func encryptFile(inputFile string) string {
	//Step 1: Generate a random 256-bit(32-byte)AES key
	key := make([]byte, 32) //32bytes=256 bits
	if _, err := rand.Read(key); err != nil {
		fmt.Printf("Failed to generate random key: %v\n", err)
	}

	//Step 2: Print the key in hexadecimal format
	fmt.Printf("Generated AES key (hex): %x\n", key)
	fmt.Printf("Save this key securely for decryption!\n")

	//Step 3: Read the file to encrypt
	plaintext, err := os.ReadFile(inputFile)
	if err != nil {
		fmt.Printf("Failed to read file: %v\n", err)
	}

	//Step 4: Create the AES cipher block
	block, err := aes.NewCipher(key)
	if err != nil {
		fmt.Printf("Failed to create cipher: %v\n", err)
	}

	//Step 5: Create a Galois/Counter Mode(GCM) cipher for authnticated encryption
	gcm, err := cipher.NewGCM(block)
	if err != nil {
		fmt.Printf("Failed to create GCM: %v\n", err)

	}

	//Step 6: Generate a random nonce(number used once)
	//Nonce should be unique for each encryption with the same key
	nonce := make([]byte, gcm.NonceSize())
	if _, err := io.ReadFull(rand.Reader, nonce); err != nil {
		fmt.Printf("Failed to generate nonce: %v\n", err)

	}

	//Step 7: Encrypt the data using GCM
	//The nonce is prepended to the ciphertext  for use during decryption
	ciphertext := gcm.Seal(nonce, nonce, plaintext, nil)

	outputFile := "hello.txt.encrypted"
	//step 8: Write the encrypted data to a new file
	if err := os.WriteFile(outputFile, ciphertext, 0644); err != nil {
		fmt.Printf("Failed to write encrypted file: %v\n", err)

	}

	return outputFile
}
/*
>go run main.go
Generated AES key (hex): f38e08b5a94241d4a48c657fcfb640264d9c4c6822b4c04ad213e98f9234ab2d
Save this key securely for decryption!
File encrypted successfully!
Original: hello.txt
Encrypted: hello.txt.encrypted

IMPORTANT: Keep the key safe! Without it, the file cannot be decrypted
*/